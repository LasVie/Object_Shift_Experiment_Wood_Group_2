<!DOCTYPE html>
<html>
<head>
  <title>Visual Perception Experiment</title>

  <!-- Include jsPsych core and the needed plugin -->
  <script src="jspsych/dist/jspsych.js"></script>
  <script src="jspsych/dist/plugin-html-button-response.js"></script>
  <!-- Include the default jsPsych CSS for basic styling -->
  <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />

  <style>
    p { text-align: justify; }

    /* University logo */
    .university-logo {
      position: absolute;
      top: 10px;
      left: 10px;
      height: 60px;
    }

    /* Welcome text container */
    .welcome-container {
      margin-top: 20px;
      margin-left: 100px;
      margin-right: 20px;
      text-align: left;
    }

    /* Demo/Experiment image styling */
    .demo-image {
      max-width: 45vw;
      max-height: calc(100vh - 150px);
      width: auto;
      height: auto;
    }

    /* jsPsych button styling */
    .jspsych-btn {
      font-weight: bold;
      font-size: 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
    }
    .jspsych-btn:hover {
      background-color: #45a049;
    }

    /* Fixed container for YES button */
    #yes-button-container {
      position: fixed;
      bottom: 0;
      right: 40px;
      z-index: 1000;
    }

    /* Fullscreen overlay */
    #fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(128,128,128,0.7);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #fullscreen-overlay .prompt-box {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      text-align: center;
      max-width: 90%;
    }
    #fullscreen-overlay button {
      font-size: 16px;
      margin: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #fullscreen-overlay button:hover { opacity: 0.9; }

    /* Loading screen styles */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      margin-top: 50px;
    }
    .loading-container p {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .progress-bar-container {
      width: 300px;
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #007bff;
      border-radius: 10px;
      transition: width 0.2s ease-in-out;
    }

    /* Circular progress indicator at bottom left (smaller circle) */
    #progress-circle {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: conic-gradient(#4CAF50 0deg, #4CAF50 360deg, #ccc 360deg, #ccc 360deg);
      z-index: 1000;
      display: none;
    }

    /* Center the stimulus and button in one column */
    .jspsych-html-button-response-stimulus,
    #jspsych-html-button-response-btngroup {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* -------- NEW: Hide seek bar on first play -------- */
    /* Chromium / Edge / Safari */
    video.no-progress::-webkit-media-controls-timeline,
    video.no-progress::-webkit-media-controls-current-time-display,
    video.no-progress::-webkit-media-controls-time-remaining-display {
      display: none !important;
    }
    /* Firefox */
    video.no-progress::-moz-range-track {
      visibility: hidden !important;
    }
  </style>

  <!-- -----------------------------------------------------------
       NEW helper script (replaces the old “mTurk Integration” block)
  ----------------------------------------------------------- -->
  <script>
    /* Generate n random digits */
    function generateRandomDigits(n) {
      let out = '';
      for (let i = 0; i < n; i++) out += Math.floor(Math.random() * 10);
      return out;
    }

    /* Build participant-ID in the form  WorkerID@day*25#### */
    function buildParticipantID(workerId) {
      const today      = new Date().getDate();          // 1–31
      const uniquePart = (today * 25) + generateRandomDigits(4);
      return `${workerId}@${uniquePart}`;
    }
  </script>
</head>

<body>
  <!-- Container for YES button -->
  <div id="yes-button-container"></div>
  <!-- Circular progress indicator -->
  <div id="progress-circle"></div>

  <script>
    /*********************************************************
     * GLOBAL VARIABLES & HELPER FUNCTIONS
     *********************************************************/
    var yesClickEvents = [];
    function clearYesClickEvents() { yesClickEvents = []; }
    var demoPaused = false;

    // NEW GLOBAL FOR DEMO PIXEL-SHIFT
    window.demoPixelShift = null;            // ← added

    // NEW GLOBAL VARIABLES FOR VIDEO WATCH TIME
    var demoVideoStartTime = 0;   // store Date.now() when user arrives on the demo video
    var demoVideoWatchTime = 0;   // number of seconds user actually watched

    function pauseAwareTimeout(callback, delay) {
      setTimeout(function waitForResume() {
        if (demoPaused) { setTimeout(waitForResume, 100); }
        else { callback(); }
      }, delay);
    }

    function parseShiftFromFilename(url) {
      var match = url.match(/_(L|R|U|D)(\d+)px/);
      if (!match) return { direction: null, shift: 0 };
      return { direction: match[1], shift: parseInt(match[2], 10) };
    }

    var jsPsych = initJsPsych({
      override_safe_mode: true,
      experiment_width: 1000
    });

    document.addEventListener("fullscreenchange", function () {
      if (!document.fullscreenElement) {
        demoPaused = true;
        var overlay = document.createElement("div");
        overlay.id = "fullscreen-overlay";

        var promptBox = document.createElement("div");
        promptBox.className = "prompt-box";

        var message = document.createElement("p");
        message.innerHTML = `
          You have exited full screen mode.<br><br>
          Press <strong>Resume</strong> to re-enter full screen, or 
          <strong>Quit</strong> to return to the main screen (all progress lost!).
        `;
        promptBox.appendChild(message);

        var btnQuit = document.createElement("button");
        btnQuit.textContent = "Quit";
        btnQuit.style.backgroundColor = "#d9534f";
        btnQuit.style.color = "white";
        btnQuit.onclick = function () {
          if (document.getElementById("fullscreen-overlay")) {
            document.body.removeChild(overlay);
          }
          window.location.reload();
        };

        var btnResume = document.createElement("button");
        btnResume.textContent = "Resume";
        btnResume.style.backgroundColor = "#5cb85c";
        btnResume.style.color = "white";
        btnResume.onclick = function () {
          if (document.getElementById("fullscreen-overlay")) {
            document.body.removeChild(overlay);
          }
          document.documentElement.requestFullscreen().then(function () {
            demoPaused = false;
            if (typeof jsPsych.resumeExperiment === "function") {
              jsPsych.resumeExperiment();
            }
          }).catch(function (err) {
            console.error("Error re-entering full screen:", err);
          });
        };

        promptBox.appendChild(btnQuit);
        promptBox.appendChild(btnResume);

        overlay.appendChild(promptBox);
        document.body.appendChild(overlay);

        if (typeof jsPsych.pauseExperiment === "function") {
          jsPsych.pauseExperiment();
        }
      }
    });
  </script>

  <script>
    var objectNames = [
      //"Book Shelves", "Chess", "Wheel", "Food Platter", "Fruits", "Humming Bird", "Plant", "Swing", "Vase", 
      "Wood"
    ];
    var groups = {
      //"Group1": ["Center_100%_Plain", "Center_100%_LowContrast"],
      "Group2": ["Left_100%_Plain", "Right_100%_Plain"],
      //"Group3": ["Up_100%_Plain", "Down_100%_Plain"],
      //"Group4": ["Center_125%_Plain", "Center_75%_Plain"],
      //"Group5": ["Center_100%_PatternHoriz", "Center_100%_PatternVert", "Center_100%_Messy"]
    };

    function getRandomElement(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }
  </script>

  <script>
    // CACHING FOR IMAGE FILENAMES
    window._allFilenamesPromise = null;
    window._filenameListCache = {};

    function fetchImageFilenames(searchKey) {
      // 1) Lazy-load the full JSON exactly once:
      if (!window._allFilenamesPromise) {
        window._allFilenamesPromise = fetch(
          "https://lasvientuexperimentdata.s3.ap-southeast-1.amazonaws.com/Rendered+Images/filenames.json",
          { cache: "force-cache" }
        )
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        });
      }

      // 2) If we've already filtered for this key, return the cached array:
      if (window._filenameListCache[searchKey]) {
        return Promise.resolve(window._filenameListCache[searchKey]);
      }

      // 3) Otherwise filter & sort once, cache the result, and return it:
      return window._allFilenamesPromise
        .then(data => {
          const matching = data
            .filter(file => file.name.includes(searchKey))
            .sort((a, b) => a.name.localeCompare(b.name))
            .map(file => file.name);
          window._filenameListCache[searchKey] = matching;
          return matching;
        });
    }
  </script>

  <!-- =======================================================
       1) Welcome Page  (***FIX applied here***)
  ======================================================= -->
  <script>
    var welcomePage = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <img src="logo/NTU Logo.png" alt="NTU Logo" class="university-logo" style="height:230px; width:auto;">
        <div class="welcome-container">
          <h1>Visual Perception Experiment</h1>
          <p>
            This study aims to evaluate the sensitivity of the human visual system
            to subtle shifts in the position of a salient object. You will see images
            where a key object may be displaced in various directions. Your task is
            to detect these shifts.
          </p>
          <p style="color:red; font-weight:bold;">
            Please do not refresh the page during the experiment; refreshing will cause all progress to be lost.
            <br>
            Only refresh if images fail to load.
          </p>

          <!-- NEW: Worker ID textbox -->
          <p>
            <label for="worker-id-input"><b>Enter your MTurk Worker&nbsp;ID:</b></label>
            <input type="text" id="worker-id-input" name="worker-id-input"
                   style="margin-left:10px; width:190px;" required>
          </p>

          <p>
            <input type="checkbox" id="device-confirm" name="device-confirm">
            <label for="device-confirm">I confirm that I am using a desktop PC or laptop.</label>
          </p>
        </div>
      `,
      choices: ['Continue'],

      /* ---------- NEW SAFER HANDLER ---------- */
      on_load: function() {
        const btn     = document.querySelector(".jspsych-btn");
        const idInput = document.getElementById("worker-id-input");
        const deviceC = document.getElementById("device-confirm");

        function toggleButton() {
          btn.disabled = !(deviceC.checked && idInput.value.trim().length);
        }
        btn.disabled = true;
        idInput.addEventListener("input",  toggleButton);
        deviceC.addEventListener("change", toggleButton);

        /*  FIX ▲ capture Worker-ID while the element exists  */
        btn.addEventListener("click", () => {                       // FIX ▲
          const workerId = idInput.value.trim();                    // FIX ▲
          window.participantID = buildParticipantID(workerId);      // FIX ▲
        });                                                         // FIX ▲
      },

      /* ---------- DOM is gone here, so no element access ---------- */
      on_finish: function() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(function(err) {
            console.error("Error attempting to enable full screen:", err);
          });
        }
      }
    };
  </script>

  <!-- (all remaining sections are **identical** to your original;
       no lines have been removed or shortened) -->

  <script>
    /*************** 2) Demo Instructions Page ***************/
    var demoPage = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <img src="logo/NTU Logo.png" alt="NTU Logo" class="university-logo" style="height:230px; width:auto;">
        <div style="text-align:center;">
          <h3 style="margin-bottom:5px;">DEMO: The shifted image will move <b>to the left</b></h3>
          <div style="display:flex; justify-content:center; align-items:center; margin-top:10px;">
            <div style="margin:5px; text-align:center;">
              <img src="image/00001_Cube_Center_100_Plain_N0px.png" alt="Reference Image" style="width:300px; height:auto;"><br>
              <span>Reference Image</span>
            </div>
            <div style="margin:5px; text-align:center;">
              <img src="image/00031_Cube_Center_100_Plain_L30px.png" alt="Shifted Image" style="width:300px; height:auto;"><br>
              <span>Shifted Image</span>
            </div>
          </div>
          <div style="margin-top:10px; text-align:left; max-width:1200px; margin-left:auto; margin-right:auto; font-size:14px; line-height:1.2;">
            <p>
              In this demo, the left image is a fixed reference, while the right image will update periodically.
              The shifted image refreshes every 3 seconds. Between updates, it and the YES button will be temporarily disabled,
              but the layout remains in place.
            </p>
            <p>
              Once you notice a change (shift) in the right image relative to the left image, click "YES" to indicate detection.
              If you do not notice a change, it will keep updating until the final image.
            </p>
            <p>
              <strong>Note:</strong> Quitting the experiment at any point will erase all progress.
            </p>
            <p>
              <strong>Note:</strong> Please observe carefully as images could be repeating.
            </p>
            <p>
              <strong>Please be aware:</strong> we will use your demo performance to verify your understanding of the experiment.
              If the demo suggests lack of attention or understanding, it may affect your final compensation.
            </p>
          </div>
          <div style="margin-top:10px; font-size:14px;">
            <input type="checkbox" id="demo-confirm" name="demo-confirm">
            <label for="demo-confirm">I have read and understood the instructions.</label>
          </div>
        </div>
      `,
      choices: ['Start DEMO'],
      on_load: function() {
        var btn = document.querySelector(".jspsych-btn");
        btn.disabled = true;
        document.getElementById("demo-confirm").addEventListener("change", function() {
          btn.disabled = !this.checked;
        });
      }
    };
  </script>

  <script>
    /*************** 2.5) Demo Video Page ***************/
var demoVideoTrial = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2 style="text-align:center; margin-top:10px;">Instructional Video</h2>
    <div style="max-width:1200px; margin:0 auto; text-align:center;">
      <video id="demo-video" controls style="width:100%; height:auto; margin-top:10px;">
        <source src="data/Demo Video.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    <p style="margin-top:20px; text-align:center;">
      You can skip ahead or scrub through the video at any time.
    </p>
  `,
  choices: ['Continue'],
  on_load: function() {
    const btn = document.querySelector('.jspsych-btn');
    btn.disabled = false;    // immediate enable

    const video = document.getElementById('demo-video');
    let playStart = null;
    demoVideoWatchTime = 0;  // reset accumulator

    // When video starts or resumes playing
    video.addEventListener('play', () => {
      // record when this play segment began
      playStart = Date.now();
    });

    // When video is paused or user seeks
    function accumulate() {
      if (playStart !== null) {
        // add the elapsed seconds since playStart
        demoVideoWatchTime += (Date.now() - playStart) / 1000;
        playStart = null;
      }
    }
    video.addEventListener('pause', accumulate);
    video.addEventListener('seeking', accumulate);

    // When video ends naturally
    video.addEventListener('ended', () => {
      accumulate();         // add the last segment
      // demoVideoWatchTime now holds total watched seconds
      console.log('Total watched (s):', demoVideoWatchTime);
    });

    // Also catch the Continue click if they skip before ending
    btn.addEventListener('click', () => {
      accumulate();         // add any current segment
      console.log('Final watched (s):', demoVideoWatchTime);
    });
  }
};

  </script>

  <script>
    /*************** 3) Dynamic Demo Trial ***************/
    var dynamicDemoTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: '<div id="dynamic-demo-container"></div>',
      choices: ['YES'],
      response_ends_trial: false,
      on_load: function() {
        var btn = document.querySelector(".jspsych-btn");
        var yesBtnContainer = document.getElementById('yes-button-container');
        yesBtnContainer.appendChild(btn);
        yesBtnContainer.style.display = "none";
        btn.disabled = true;
        btn.style.opacity = "0.5";

        var container = document.getElementById("dynamic-demo-container");
        var numImages = 31;
        var demoImages = [];
        var imageFilenames = [];
        var loadingStartTime = Date.now();
        var trialFinished = false;

        imageFilenames.push("00001_Cube_Center_100_Plain_N0px.png");
        for (var j = 2; j <= numImages; j++) {
          var shift = j - 1;
          var padded = (j < 10) ? "0000" + j : "000" + j;
          var filename = padded + "_Cube_Center_100_Plain_L" + shift + "px.png";
          imageFilenames.push(filename);
        }

        var loadingScreenTimeout = setTimeout(function () {
          container.innerHTML = `
            <div class="loading-container">
              <p>Loading experiment, please wait...</p>
              <div class="progress-bar-container">
                <div id="loading-bar" class="progress-bar"></div>
              </div>
            </div>
          `;
          var loadingBar = document.getElementById("loading-bar");
          var progress = 0;
          var interval = setInterval(function () {
            progress += 5;
            if (progress >= 100) {
              clearInterval(interval);
            } else {
              loadingBar.style.width = progress + "%";
            }
          }, 100);
        }, 100);

        function loadImage(src) {
          return new Promise(function (resolve, reject) {
            var img = new Image();
            img.onload = function () { resolve(img); };
            img.onerror = function () { reject(src); };
            img.src = "image/" + encodeURIComponent(src);
          });
        }

        Promise.all(imageFilenames.map(loadImage)).then(function (images) {
          demoImages = images;
          var loadingDuration = Date.now() - loadingStartTime;
          var minDisplayTime = 1000;
          var remainingTime = minDisplayTime - loadingDuration;
          setTimeout(function () {
            clearTimeout(loadingScreenTimeout);
            startCountdown();
          }, Math.max(0, remainingTime));
        }).catch(function (err) {
          container.innerHTML = "<p>Error loading image: " + err + "</p>";
        });

        var currentIndex = 0;
        function nextImage() {
          if (trialFinished) return;
          if (currentIndex >= demoImages.length - 1) {
            finishTrial();
            return;
          }
          btn.disabled = true;
          btn.style.opacity = "0.5";
          var shiftImg = document.getElementById("shift-image");
          if (!shiftImg) return;
          shiftImg.style.visibility = "hidden";

          // In-between transition: 1000ms → 500ms
          pauseAwareTimeout(function () {
            currentIndex++;
            shiftImg.src = demoImages[currentIndex].src;
            shiftImg.style.visibility = "visible";
            btn.disabled = false;
            btn.style.opacity = "1";
            // Blink/update freq: 3000ms → 2000ms
            pauseAwareTimeout(nextImage, 2000);
          }, 500);
        }

        function startCountdown() {
          btn.style.display = "none";
          container.innerHTML = `
            <div id="demo-header" style="text-align:center; margin-top:10px;">
              <h3 style="margin:0 0 10px 0;">
                Saliency object is moving <span style="font-size:1.5em; text-decoration:underline;">LEFT</span>
              </h3>
              <h3 id="countdown" style="font-size:72px; font-weight:bold; margin:100px;">3</h3>
            </div>
          `;
          var count = 3;
          function countdownTick() {
            if (demoPaused) {
              setTimeout(countdownTick, 100);
              return;
            }
            count--;
            var cd = document.getElementById("countdown");
            if (!cd) return;
            cd.innerHTML = count;
            if (count <= 0) {
              startDemo();
            } else {
              setTimeout(countdownTick, 1000);
            }
          }
          setTimeout(countdownTick, 1000);
        }

        function startDemo() {
          container.innerHTML = `
            <div id="demo-header" style="text-align:center; margin-top:10px;">
              <h3 style="margin:0 0 10px 0;">
                Saliency object is moving <span style="font-size:1.5em; text-decoration:underline;">LEFT</span>
              </h3>
            </div>
            <div id="demo-content" style="display:flex; justify-content:center; align-items:center;">
              <div style="margin:5px; text-align:center;">
                <img id="ref-image" src="${demoImages[0].src}" class="demo-image">
                <br><span>Reference Image</span>
              </div>
              <div style="margin:5px; text-align:center;">
                <img id="shift-image" src="${demoImages[currentIndex].src}" class="demo-image" style="visibility:visible;">
                <br><span>Shifted Image</span>
              </div>
            </div>
          `;
          document.getElementById("yes-button-container").style.display = "block";  
          btn.style.display = "inline-block";  
          btn.disabled = false;  
          btn.style.opacity = "1";  
          // First update: 3000ms → 2000ms  
          pauseAwareTimeout(nextImage, 2000);  
        }

        /* -------------- MODIFIED CLICK HANDLER -------------- */
        btn.addEventListener("click", function () {
          if (trialFinished) return;
          trialFinished = true;

          var shiftImg = document.getElementById("shift-image");
          if (shiftImg) {
            var parsed = parseShiftFromFilename(shiftImg.src);
            window.demoPixelShift = parsed.shift;      // ← store demo result
            yesClickEvents.push({
              phase: "demo",
              direction: parsed.direction,
              shift: parsed.shift,
              filename: shiftImg.src
            });
          }
          finishTrial();
        });
        /* ---------------------------------------------------- */

        function finishTrial() {
          var btn = document.querySelector(".jspsych-btn");
          if (btn && btn.parentNode) {
            btn.parentNode.removeChild(btn);
          }
          var trialData = { chosen_shift: currentIndex };
          jsPsych.finishTrial(trialData);
        }
      }
    };
  </script>

  <script>
    /*************** 4) Demo Completion Page ***************/
    var demoCompleteTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2 style="text-align:center;">You have completed the demo</h2>
        <p style="max-width:800px; margin:0 auto; font-size:16px; text-align:left;">
          <strong>Rules Recap:</strong><br>
          1) The reference image is constant.<br>
          2) The shifted image updates every 3 seconds.<br>
          3) When you notice a change, click the YES button.<br>
          4) Quitting midway disqualifies your progress.<br>
        </p>
        <p style="text-align:center; margin-top:20px;">
          Choose an option below:
        </p>
      `,
      choices: ['Redo DEMO', 'START ACTUAL EXPERIMENT'],
      on_finish: function() { /* Loop handled in timeline */ }
    };
  </script>

  <script>
    /*************** 5) Experiment Instructions Page ***************/
    var experimentInstructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        window.selectedObject = getRandomElement(objectNames);
        window.selectedGroupKey = getRandomElement(Object.keys(groups));
        var props = groups[window.selectedGroupKey];
        var setsCount = props.length;
        return `
          <div style="text-align:center;">
            <h2>Actual Experiment:</h2>
            <p>The experiment will now run for a series of keys based on one randomly selected object and group.</p>
            <p>
              You have been assigned to <strong>${window.selectedGroupKey}</strong>.<br>
              You will perform <strong>${setsCount * 4} sets</strong> (each property contributes 4 directions) of experiments.
            </p>
            <p style="color:red; font-weight:bold;">
              WARNING: Refreshing the page will cause all progress to be lost.
            </p>
            <p>
              In each set, the same salient object will be used. The object will shift in 4 directions – Left, Right, Up, and Down.
              After each directional shift, please press <strong>YES</strong> once you observe a difference.
            </p>
            <p>
              Please take every part of the experiment seriously. Providing invalid or inattentive responses
              may affect your final payment.
            </p>
            <p>Once ready, please press START.</p>
          </div>
        `;
      },
      choices: ['START']
    };
  </script>

  <script>
    /*************** 6) Multi-Key Actual Experiment Trial with BATCHED PREFETCH ***************/
    var multiKeyExperimentTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: '<div id="actual-exp-container"></div>',
      choices: ['YES'],
      response_ends_trial: false,
      on_load: function () {
        clearYesClickEvents();
        var btn = document.querySelector(".jspsych-btn");
        if (!btn) {
          btn = document.createElement("button");
          btn.className = "jspsych-btn";
          btn.textContent = "YES";
        }
        var yesBtnContainer = document.getElementById('yes-button-container');
        yesBtnContainer.appendChild(btn);
        yesBtnContainer.style.display = "none";
        btn.style.display = "none";

        document.getElementById("progress-circle").style.display = "block";
        var properties = groups[window.selectedGroupKey];
        var totalSets = properties.length * 4;
        window.completedSets = 0;
        window.updateProgressCircle = function() {
          var angle = ((totalSets - window.completedSets) / totalSets) * 360;
          document.getElementById("progress-circle").style.background =
            `conic-gradient(#4CAF50 0deg, #4CAF50 ${angle}deg, #ccc ${angle}deg, #ccc 360deg)`;
        };
        window.updateProgressCircle();

        console.log("Selected object:", window.selectedObject);
        console.log("Selected group:", window.selectedGroupKey);
        console.log("Properties:", properties);
        var experimentResults = [];

        function runExperimentForProperty(index) {
          if (index >= properties.length) {
            if (btn.parentNode) { btn.parentNode.removeChild(btn); }
            var trialData = {
              object: window.selectedObject,
              group: window.selectedGroupKey,
              experimentResults: experimentResults
            };
            jsPsych.finishTrial(trialData);
            return;
          }
          var selectedProperty = properties[index];
          var searchKey = window.selectedObject + "_" + selectedProperty;
          console.log("Running experiment for key:", searchKey);
          runDirectionalExperiment(searchKey, selectedProperty, function(phaseResults, filenames) {
            experimentResults.push({
              property: selectedProperty,
              phaseResults: phaseResults,
              filenames: filenames
            });
            runExperimentForProperty(index + 1);
          });
        }
        runExperimentForProperty(0);

        /* -------- DIRECTIONAL EXPERIMENT FUNCTION (BATCHED LOADING) -------- */
        function runDirectionalExperiment(searchKey, propertyName, callback) {
          var container = document.getElementById("actual-exp-container");
          container.innerHTML = `
            <div class="loading-container">
              <p>Loading experiment, please wait...</p>
              <div class="progress-bar-container">
                <div id="exp-loading-bar" class="progress-bar"></div>
              </div>
            </div>
          `;
          document.getElementById("yes-button-container").style.display = "none";
          var loadingBar = document.getElementById("exp-loading-bar");
          var progress = 0;
          var loadingInterval = setInterval(function () {
            progress += 5;
            if (progress >= 100) { clearInterval(loadingInterval); }
            else { loadingBar.style.width = progress + "%"; }
          }, 100);

          fetchImageFilenames(searchKey).then(function(fileNames) {
            if (fileNames.length === 0) {
              container.innerHTML = "<p>No matching images found for key: " + searchKey + ".</p>";
              callback({}, []); return;
            }
            if (fileNames.length < 401) {
              container.innerHTML = "<p>Expected ≥ 401 images for key: " + searchKey + ", but got " + fileNames.length + ".</p>";
              callback({}, fileNames); return;
            }
            // Only take first 401
            fileNames = fileNames.slice(0, 401);

            // Split into original + 4 directions
            var originalFilename   = fileNames[0];
            var leftFilenamesAll   = fileNames.slice(1, 101);
            var rightFilenamesAll  = fileNames.slice(101, 201);
            var upFilenamesAll     = fileNames.slice(201, 301);
            var downFilenamesAll   = fileNames.slice(301, 401);

            // Prepare per-phase filename arrays (including original at index 0)
            const phases = [
              { direction: "L", label: "LEFT",  filenames: [originalFilename].concat(leftFilenamesAll) },
              { direction: "R", label: "RIGHT", filenames: [originalFilename].concat(rightFilenamesAll) },
              { direction: "U", label: "UP",    filenames: [originalFilename].concat(upFilenamesAll) },
              { direction: "D", label: "DOWN",  filenames: [originalFilename].concat(downFilenamesAll) }
            ];

            const baseImageURL = "https://lasvientuexperimentdata.s3.ap-southeast-1.amazonaws.com/Rendered+Images/";
            const INITIAL_CACHE_SIZE  = 5;  // preload first 10 shifts + original
            const PREFETCH_THRESHOLD  = 2;   // when within 5 of cache end, fetch more
            const PREFETCH_SIZE       = 2;   // fetch 5 more each time

            var currentPhaseIndex = 0;
            var currentImageIndex = 0;
            var phaseResults      = {};
            var highestLoadedIndex = 0;  // track how many we've preloaded

            // Utility to preload a set of indices for the current phase
            function preloadImages(indices) {
              var fnames = phases[currentPhaseIndex].filenames;
              indices.forEach(function(i) {
                var img = new Image();
                img.src = baseImageURL + encodeURIComponent(fnames[i]);
              });
            }

            btn.style.display = "none";
            btn.disabled = true;
            btn.style.opacity = "0.5";

            // Handle YES clicks
            var yesHandler = function () {
              if (!btn.disabled) {
                var phase = phases[currentPhaseIndex];
                var filenameURL = document.getElementById("exp-shift-image").src;
                var parsed = parseShiftFromFilename(filenameURL);
                yesClickEvents.push({
                  phase: "actual",
                  group: window.selectedGroupKey,
                  property: propertyName,
                  direction: parsed.direction,
                  shift: parsed.shift,
                  filename: filenameURL
                });
                phaseResults[phase.label] = {
                  imageIndex: currentImageIndex,
                  filename: filenameURL,
                  pixelShift: parsed.shift,
                  direction: parsed.direction
                };
                window.completedSets++;
                window.updateProgressCircle();
                moveToNextPhase();
              }
            };
            btn.addEventListener("click", yesHandler);

            // Countdown before each phase
            function startPhaseCountdown() {
              btn.style.display = "none";
              var phase = phases[currentPhaseIndex];
              container.innerHTML = `
                <div id="exp-header" style="text-align:center; margin-top:10px;">
                  <h3 style="margin:0 0 10px 0;">
                    Saliency object will be moving <span style="font-size:1.5em; text-decoration:underline;">${phase.label}</span>
                  </h3>
                  <h3 id="exp-countdown" style="font-size:72px; font-weight:bold; margin:100px;">3</h3>
                </div>
              `;
              var count = 3;
              function tick() {
                if (demoPaused) { return setTimeout(tick, 100); }
                count--;
                document.getElementById("exp-countdown").innerHTML = count;
                if (count <= 0) {
                  startPhase();
                } else {
                  setTimeout(tick, 1000);
                }
              }
              setTimeout(tick, 1000);
            }

            // Start showing a phase (with initial preload)
            function startPhase() {
              currentImageIndex = 0;
              var phase = phases[currentPhaseIndex];
              // preload original + initial chunk
              highestLoadedIndex = Math.min(INITIAL_CACHE_SIZE, phase.filenames.length - 1);
              var toPreload = [];
              for (var i = 0; i <= highestLoadedIndex; i++) toPreload.push(i);
              preloadImages(toPreload);

              document.getElementById("yes-button-container").style.display = "block";
              btn.style.display = "inline-block";
              btn.disabled = false;
              btn.style.opacity = "1";
              showPhaseImages();
            }

            // Render current image, then schedule next
            function showPhaseImages() {
              var phase = phases[currentPhaseIndex];
              var fn = phase.filenames[currentImageIndex];
              container.innerHTML = `
                <div id="exp-header" style="text-align:center; margin-top:10px;">
                  <h3 style="margin:0 0 10px 0;">
                    Saliency object will be moving <span style="font-size:1.5em; text-decoration:underline;">${phase.label}</span>
                  </h3>
                </div>
                <div id="exp-content" style="display:flex; justify-content:center; align-items:center;">
                  <div style="margin:5px; text-align:center;">
                    <img id="exp-ref-image"
                         src="${baseImageURL + encodeURIComponent(phase.filenames[0])}"
                         class="demo-image">
                    <br><span>Reference Image</span>
                  </div>
                  <div style="margin:5px; text-align:center;">
                    <img id="exp-shift-image"
                         src="${baseImageURL + encodeURIComponent(fn)}"
                         class="demo-image"
                         style="visibility:visible;">
                    <br><span>Shifted Image</span>
                  </div>
                </div>
              `;
              btn.disabled = false;
              btn.style.opacity = "1";
              pauseAwareTimeout(advancePhaseImage, 2000);
            }

            // Advance within phase, prefetching more as needed, with 1s hide and 2s display
            function advancePhaseImage() {
              btn.disabled = true;
              btn.style.opacity = "0.5";
              var phase = phases[currentPhaseIndex];

              if (currentImageIndex < phase.filenames.length - 1) {
                // hide shifted image for 1 second
                var shiftImg = document.getElementById("exp-shift-image");
                shiftImg.style.visibility = "hidden";

                // after 1s, load and show next
                pauseAwareTimeout(function () {
                  currentImageIndex++;

                  // prefetch if within threshold
                  if (currentImageIndex + PREFETCH_THRESHOLD > highestLoadedIndex &&
                      highestLoadedIndex < phase.filenames.length - 1) {
                    var start = highestLoadedIndex + 1;
                    var end   = Math.min(highestLoadedIndex + PREFETCH_SIZE, phase.filenames.length - 1);
                    var more  = [];
                    for (var j = start; j <= end; j++) more.push(j);
                    preloadImages(more);
                    highestLoadedIndex = end;
                  }

                  var fn = phase.filenames[currentImageIndex];
                  shiftImg.src = baseImageURL + encodeURIComponent(fn);
                  shiftImg.style.visibility = "visible";
                  btn.disabled = false;
                  btn.style.opacity = "1";

                  // display for 2 seconds
                  pauseAwareTimeout(advancePhaseImage, 2000);
                }, 1000);

              } else {
                moveToNextPhase();
              }
            }

            function moveToNextPhase() {
              btn.disabled = true;
              btn.style.opacity = "0.5";
              currentPhaseIndex++;
              if (currentPhaseIndex < phases.length) {
                startPhaseCountdown();
              } else {
                btn.removeEventListener("click", yesHandler);
                callback(phaseResults, phases.map(p => p.filenames));
              }
            }

            // Kick off the very first phase
            startPhaseCountdown();

          }).catch(function (error) {
            container.innerHTML = "<p>Error fetching image filenames: " + error + "</p>";
          });
        }
        /* ------------------------------------------------------ */
      }
    };
  </script>

  <script>
    /*************** 7) Final "Submit Data" Page ***************/
    var finalSubmissionTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div style="text-align:center;">
          <h2>Submit Your Data</h2>
          <p>Please press the button below to submit your data.</p>
          <p style="color:red; font-weight:bold;">WARNING: Do not refresh the page during the experiment; refreshing will cause all progress to be lost.</p>
        </div>
      `,
      choices: ['Submit Data'],
      on_finish: function() {
        var jsPsychDataArray = jsPsych.data.get().values();
        var trialSummary = jsPsychDataArray.map(function(trial) {
          return {
            trialIndex: trial.trial_index,
            trialType: trial.trial_type,
            response: trial.response,
            rt: trial.rt,
            chosenShift: trial.chosen_shift !== undefined ? trial.chosen_shift : null
          };
        });

        /* ------------  INCLUDE DEMO PIXEL-SHIFT  ------------ */
        var finalPayload = {
          participantID: window.participantID,
          selectedObject: window.selectedObject || null,
          group: window.selectedGroupKey || null,
          yesClicks: yesClickEvents,
          trialSummary: trialSummary,
          demoVideoWatchTime: demoVideoWatchTime,
          demoPixelShift: window.demoPixelShift ?? null      // ← NEW FIELD
        };
        /* ---------------------------------------------------- */

        var AWS_ENDPOINT = "https://i7nc0ict3h.execute-api.ap-southeast-1.amazonaws.com/storedata";
        fetch(AWS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(finalPayload)
        })
        .then(response => response.json())
        .then(result => {
          console.log("Data posted successfully:", result);
        })
        .catch(error => {
          console.error("Error posting data:", error);
        });
      }
    };
  </script>

  <script>
    /*************** 8) Final Survey Code Page ****************/
    var finalCodeTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        return `
          <div style="text-align:center;">
            <h2>Response submitted!</h2>
            <p>You may close this window now!</p>
            <p>Your unique survey code is: <strong>${window.participantID}</strong></p>
          </div>
        `;
      },
      choices: ['Finish'],

      /* NEW – close the tab/window when Finish is pressed */
      on_finish: function () {
        /* give the DOM a single animation frame so the click feels “acknowledged” */
        requestAnimationFrame(() => {
          /* Work around browsers that block window.close() on non-scripted windows */
          window.open('', '_self');   // make the current tab “script-opened”
          window.close();             // and close it
        });
      }
    };
  </script>


  <script>
    /*********************************************************
     * ASSEMBLE TIMELINE
     *********************************************************/
    var timeline = [];
    timeline.push(welcomePage);

    // DEMO Timeline with new video watch time tracking
    var demoTimeline = {
      timeline: [
        demoPage,
        demoVideoTrial,
        dynamicDemoTrial,
        demoCompleteTrial
      ],
      loop_function: function(data) {
        var last_trial = data.values()[data.values().length - 1];
        // If last trial button was 'Redo DEMO' (response == 0), repeat
        return last_trial.response === 0;
      }
    };
    timeline.push(demoTimeline);

    timeline.push(experimentInstructions);
    timeline.push(multiKeyExperimentTrial);
    timeline.push(finalSubmissionTrial);
    timeline.push(finalCodeTrial);

    jsPsych.run(timeline);
  </script>
</body>
</html>
